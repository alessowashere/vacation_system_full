{% extends "base.html" %}
{% block content %}
<div class="p-4 bg-gray-50 min-h-screen">
    <div class="flex justify-between items-center mb-6 no-print">
        <h1 class="text-xl font-black text-gray-800 uppercase tracking-tighter">Gesti&oacute;n de Personal UAC</h1>
        <a href="{{ url_for('admin_user_new') }}" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-sm hover:bg-green-700 transition">+ Nuevo Usuario</a>
    </div>

    {% for section in hierarchy %}
    <div class="mb-4 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-4 py-1.5 {% if 'CLASIFICAR' in section.nombre %} bg-red-600 {% else %} bg-gray-800 {% endif %} text-white text-[10px] font-black uppercase tracking-widest">
            {{ section.nombre }}
        </div>
        <table class="w-full text-[11px] border-collapse">
            <tbody class="divide-y divide-gray-100">
                {% for u in section.miembros %}
                <tr class="hover:bg-blue-50/50 transition">
                    <td class="px-4 py-2 w-40 font-bold text-blue-600 uppercase">{{ u.username }}</td>
                    <td class="px-4 py-2">
                        <div class="font-bold text-gray-800">{{ u.full_name }}</div>
                        {% if u.area_erronea %}
                            <div class="text-[9px] text-red-500 font-bold italic">Registrado en: "{{ u.area_erronea }}"</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2 text-center">
                        {% if u.is_active %}
                            <span class="text-[9px] font-black text-green-600 bg-green-50 px-2 py-0.5 rounded-full border border-green-200 uppercase">Activo</span>
                        {% else %}
                            <span class="text-[9px] font-black text-red-600 bg-red-50 px-2 py-0.5 rounded-full border border-red-200 uppercase">Inactivo</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2 text-right">
                        <button onclick="openEditModal('{{ u.id }}')" class="text-indigo-600 hover:text-indigo-900 font-bold uppercase text-[10px] border border-indigo-200 px-2 py-1 rounded bg-indigo-50">
                            <i class="fas fa-edit mr-1"></i> Editar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
</div>

<div id="editModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-xl w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh]">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h3 class="font-black text-gray-700 uppercase text-xs tracking-widest">Edici&oacute;n R&aacute;pida de Usuario</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-xl font-bold">&times;</button>
        </div>
        <div id="modalBody" class="p-6 overflow-y-auto">
            <p class="text-gray-400 text-center italic py-10">Cargando...</p>
        </div>
    </div>
</div>

<script>
    async function openEditModal(userId) {
        const modal = document.getElementById('editModal');
        const body = document.getElementById('modalBody');
        
        modal.classList.replace('hidden', 'flex');
        body.innerHTML = '<div class="text-center py-10 font-bold animate-pulse text-slate-400 uppercase text-xs tracking-widest">Abriendo ficha institucional...</div>';
        
        try {
            const response = await fetch(`/gestion/admin/users/${userId}/edit`);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extraemos solo el formulario del contenido completo
            const form = doc.querySelector('form');
            
            if (form) {
                form.className = "space-y-6 text-slate-700";
                body.innerHTML = '';
                body.appendChild(form);
                
                // Estilo al botón de Guardar del modal
                const btn = form.querySelector('button[type="submit"]');
                if (btn) btn.className = "w-full bg-slate-900 hover:bg-black text-white font-black py-4 rounded-xl shadow-lg transition-all uppercase text-xs tracking-widest mt-6";
            } else {
                body.innerHTML = '<p class="text-red-500 text-center font-bold">Error: No se pudo cargar el formulario.</p>';
            }
        } catch (e) {
            body.innerHTML = '<p class="text-red-600 text-center font-bold">Error de conexión con el servidor.</p>';
        }
    }
</script>
{% endblock %}