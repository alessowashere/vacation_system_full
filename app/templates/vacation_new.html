{% extends "base.html" %}

{% block title %}Nueva Solicitud{% endblock %}

{% block content %}
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Nueva Solicitud de Vacaciones</h1>
    <div class="text-right">
      <span class="text-sm text-gray-500 block">Tu Balance Disponible:</span>
      <span class="text-lg font-bold text-green-600 block">{{ remaining_balance }} días</span>
      <a href="{{ url_for('dashboard') }}" class="text-blue-500 hover:underline text-sm">&larr; Volver al Dashboard</a>
    </div>
  </div>
  
  <form action="{{ url_for('vacation_create') }}" method="post" enctype="multipart/form-data" class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-md border border-gray-100">
    
    {# --- CORRECCIÓN: Se añadió id="target_user_id" para que el JS lo detecte correctamente --- #}
    <input type="hidden" name="target_user_id" id="target_user_id" value="{{ user.id }}">
    
    <div class="mb-6 p-3 bg-blue-50 border-l-4 border-blue-500 rounded text-blue-900 text-sm">
        <strong>Solicitante:</strong> {{ user.full_name or user.username }}
    </div>

    <div class="mb-4">
      <label for="start_date" class="block text-sm font-medium text-gray-700">Fecha de Inicio:</label>
      <input type="date" name="start_date" id="start_date" required 
             class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
    </div>
    
    <div class="mb-4">
      <label for="period_type" class="block text-sm font-medium text-gray-700">Tipo de Periodo (días):</label>
      <select name="period_type" id="period_type" required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <option value="">Seleccione un periodo...</option>
        <option value="30">30 días</option>
        <option value="15">15 días</option>
        <option value="8">8 días</option>
        <option value="7">7 días</option>
      </select>
    </div>

    <div class="mb-4 p-4 bg-gray-50 rounded-lg hidden" id="calc_result_wrapper">
      <label class="block text-sm font-medium text-gray-700">Fecha de Fin (Calculada):</label>
      <span class="text-xl font-bold text-blue-600" id="calc_end_date"></span>
      <p class="text-xs text-gray-500 mt-1">El sistema calcula automáticamente fines de semana y feriados.</p>
    </div>

    <div class="mb-4 p-4 rounded-lg hidden" id="calc_warning_wrapper">
      <span class="font-medium" id="calc_warning_text"></span>
    </div>
    
    <div class="mb-6">
      <label for="file" class="block text-sm font-medium text-gray-700">Adjuntar Documento (Opcional si es borrador):</label>
      <input type="file" name="file" id="file"
             class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
    </div>
    
    <button type="submit" 
            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      Crear Solicitud
    </button>
  </form>

  <script>
    const startDateInput = document.getElementById('start_date');
    const periodTypeInput = document.getElementById('period_type');
    const targetUserInput = document.getElementById('target_user_id'); // Ahora sí encuentra el elemento por su ID
    const resultWrapper = document.getElementById('calc_result_wrapper');
    const endDateDisplay = document.getElementById('calc_end_date');
    const warningWrapper = document.getElementById('calc_warning_wrapper');
    const warningText = document.getElementById('calc_warning_text');

    async function updateCalculations() {
      const startDate = startDateInput.value;
      const periodType = periodTypeInput.value;
      // Obtenemos el valor correctamente
      const targetUserId = targetUserInput ? targetUserInput.value : null;

      if (!startDate || !periodType) {
        resultWrapper.classList.add('hidden');
        warningWrapper.classList.add('hidden');
        return;
      }

      try {
        const response = await fetch('/gestion/api/calculate-end-date', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            start_date: startDate,
            period_type: parseInt(periodType),
            target_user_id: targetUserId ? parseInt(targetUserId) : null
          })
        });

        if (!response.ok) throw new Error('Error en la conexión o validación.');
        const data = await response.json();

        if (data.success) {
          endDateDisplay.textContent = data.end_date;
          resultWrapper.classList.remove('hidden');
          
          if (data.warning) {
            warningText.textContent = "⚠️ " + data.warning;
            warningWrapper.classList.remove('hidden');
            warningWrapper.className = 'mb-4 p-4 rounded-lg bg-yellow-50 border-yellow-500 text-yellow-800 border';
          } else {
            warningWrapper.classList.add('hidden');
          }
        } else {
          warningText.textContent = "❌ " + data.error;
          warningWrapper.classList.remove('hidden');
          warningWrapper.className = 'mb-4 p-4 rounded-lg bg-red-100 border-red-500 text-red-700 border';
          resultWrapper.classList.add('hidden');
        }
      } catch (error) {
        console.error(error);
        warningText.textContent = 'No se pudo calcular la fecha. Revise su conexión.';
        warningWrapper.classList.remove('hidden');
        warningWrapper.className = 'mb-4 p-4 rounded-lg bg-red-100 border-red-500 text-red-700 border';
      }
    }

    startDateInput.addEventListener('change', updateCalculations);
    periodTypeInput.addEventListener('change', updateCalculations);
    
    // Si el input existe, escuchamos sus cambios (por si acaso se implementa un select dinámico después)
    if (targetUserInput) {
        targetUserInput.addEventListener('change', updateCalculations);
    }
</script>
{% endblock %}