{% extends "base.html" %}

{% block title %}Nueva Solicitud{% endblock %}

{% block content %}
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Nueva Solicitud de Vacaciones</h1>
    <div>
    <span class="text-sm text-gray-500">Tu Balance Restante:</span>
    <span class="text-lg font-bold text-green-600 mr-4">{{ remaining_balance }} días</span>
    <a href="{{ url_for('dashboard') }}" class="text-blue-500 hover:underline">&larr; Volver al Dashboard</a>
  </div>
</div>
  
  <form action="{{ url_for('vacation_create') }}" method="post" enctype="multipart/form-data" class="max-w-lg mx-auto">
    
    <div class="mb-4">
      <label for="start_date" class="block text-sm font-medium text-gray-700">Fecha de Inicio:</label>
      <input type="date" name="start_date" id="start_date" required 
             class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
    </div>
    
    <div class="mb-4">
      <label for="period_type" class="block text-sm font-medium text-gray-700">Tipo de Periodo (días):</label>
      <select name="period_type" id="period_type" required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        <option value="">Seleccione un periodo...</option>
        <option value="30">30 días</option>
        <option value="15">15 días</option>
        <option value="8">8 días</option>
        <option value="7">7 días</option>
      </select>
    </div>

    <div class="mb-4 p-4 bg-gray-50 rounded-lg hidden" id="calc_result_wrapper">
      <label class="block text-sm font-medium text-gray-700">Fecha de Fin Calculada:</label>
      <span class="text-xl font-bold text-blue-600" id="calc_end_date"></span>
    </div>

    <div class="mb-4 p-4 rounded-lg hidden" id="calc_warning_wrapper">
      <span class="font-medium" id="calc_warning_text"></span>
    </div>
    
    <div class="mb-6">
      <label for="file" class="block text-sm font-medium text-gray-700">Adjuntar Documento (Obligatorio):</label>
      <input type="file" name="file" id="file"
             class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
    </div>
    
    <button type="submit" 
            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
      Crear Solicitud
    </button>
  </form>

  <script>
    const startDateInput = document.getElementById('start_date');
    const periodTypeInput = document.getElementById('period_type');
    const resultWrapper = document.getElementById('calc_result_wrapper');
    const endDateDisplay = document.getElementById('calc_end_date');
    const warningWrapper = document.getElementById('calc_warning_wrapper');
    const warningText = document.getElementById('calc_warning_text');

    async function updateCalculations() {
      const startDate = startDateInput.value;
      const periodType = periodTypeInput.value;

      if (!startDate || !periodType) {
        resultWrapper.classList.add('hidden');
        warningWrapper.classList.add('hidden');
        return;
      }

      try {
        const response = await fetch('/gestion/api/calculate-end-date', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            start_date: startDate,
            period_type: parseInt(periodType)
          })
        });

        if (!response.ok) throw new Error('Error en la conexión.');
        const data = await response.json();

        if (data.success) {
          endDateDisplay.textContent = data.end_date;
          resultWrapper.classList.remove('hidden');
          if (data.warning) {
            warningText.textContent = data.warning;
            warningWrapper.classList.remove('hidden');
            warningWrapper.className = 'mb-4 p-4 rounded-lg bg-blue-100 border-blue-500 text-blue-700';
          } else {
            warningWrapper.classList.add('hidden');
          }
        } else {
          warningText.textContent = data.error;
          warningWrapper.classList.remove('hidden');
          warningWrapper.className = 'mb-4 p-4 rounded-lg bg-red-100 border-red-500 text-red-700';
          resultWrapper.classList.add('hidden');
        }
      } catch (error) {
        warningText.textContent = 'No se pudo calcular la fecha. Revise su conexión.';
        warningWrapper.classList.remove('hidden');
        warningWrapper.className = 'mb-4 p-4 rounded-lg bg-red-100 border-red-500 text-red-700';
      }
    }

    startDateInput.addEventListener('change', updateCalculations);
    periodTypeInput.addEventListener('change', updateCalculations);
  </script>
{% endblock %}