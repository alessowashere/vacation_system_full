{% extends "base.html" %}

{% block title %}Detalles de la Solicitud{% endblock %}

{% block content %}
{% set status_map = {
    "draft": "Borrador",
    "pending_hr": "Pendiente RRHH",
    "approved": "Aprobado",
    "rejected": "Rechazado",
    "pending_modification": "Pend. Modificación",
    "pending_suspension": "Pend. Suspensión",
    "suspended": "Suspendido"
} %}
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">
      Detalles de la Solicitud
    </h1>
    <a href="{{ url_for('dashboard') }}" class="text-blue-500 hover:underline">&larr; Volver al Dashboard</a>
  </div>

  <div class="bg-white shadow-md rounded-lg p-6 mb-6">
    <div class="flex justify-between items-start">
      <h3 class="text-xl font-semibold mb-4 border-b pb-2">Resumen</h3>
      
      {% if user.role == 'manager' and vacation.status == 'approved' %}
      <div>
        <a href="{{ url_for('vacation_suspend_form', vacation_id=vacation.id) }}" class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md shadow-sm text-red-700 bg-white hover:bg-red-50">
          Solicitar Suspensión
        </a>
      </div>
      {% endif %}
      </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-500">Empleado</label>
        <span class="text-lg font-medium text-gray-900">{{ vacation.user.full_name or vacation.user.username }}</span>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">Fechas</label>
        <span class="text-lg font-medium text-gray-900">{{ vacation.start_date }} al {{ vacation.end_date }}</span>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">Estado Actual</label>
        <span class="text-lg font-medium px-3 py-1 rounded-full 
                     {% if vacation.status == 'approved' %} bg-green-100 text-green-800
                     {% elif vacation.status == 'rejected' %} bg-red-100 text-red-800
                     {% elif vacation.status == 'pending_hr' %} bg-blue-100 text-blue-800
                     {% elif vacation.status == 'pending_modification' %} bg-purple-100 text-purple-800
                     {% elif vacation.status == 'suspended' %} bg-gray-500 text-white
                     {% elif vacation.status == 'pending_suspension' %} bg-red-100 text-red-800
                     {% else %} bg-yellow-100 text-yellow-800 {% endif %}">
          {{ status_map.get(vacation.status, vacation.status) }}
        </span>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">Días Solicitados</label>
        <span class="text-lg font-medium text-gray-900">{{ vacation.type_period }} días</span>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">Días Contabilizados</label>
        <span class="text-lg font-medium text-gray-900">{{ vacation.days }} días</span>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-500">Documento Adjunto</label>
        <span class="text-lg font-medium text-blue-600">
          {% if vacation.attached_file %}
            <a href="{{ url_for('uploads', path=vacation.attached_file) }}" target="_blank" class="hover:underline">Descargar</a>
          {% else %} N/A {% endif %}
        </span>
      </div>
    </div>
  </div>
  {% if mod_requests or sus_requests or vacation.consolidated_doc_path %}
<div class="mt-6 border-t pt-4">
  <h4 class="text-md font-semibold text-gray-700 mb-2">Documentos Adicionales:</h4>
  <ul class="list-disc pl-5 text-sm text-blue-600">
    {% if vacation.consolidated_doc_path %}
      <li>
        <a href="{{ url_for('uploads', path=vacation.consolidated_doc_path) }}" target="_blank" class="hover:underline">
          Documento Consolidado (Jefe)
        </a>
      </li>
    {% endif %}
    
    {% if vacation.manager_individual_doc_path %}
      <li>
        <a href="{{ url_for('uploads', path=vacation.manager_individual_doc_path) }}" target="_blank" class="hover:underline">
          Sustento Individual (Jefe)
        </a>
      </li>
    {% endif %}
    {% for mod in mod_requests %}
      <li>
        <a href="{{ url_for('uploads', path=mod.attached_doc_path) }}" target="_blank" class="hover:underline">
          Sustento de Modificación (Jefe) - ({{ mod.status }})
        </a>
      </li>
    {% endfor %}
    {% for sus in sus_requests %}
      <li>
        <a href="{{ url_for('uploads', path=sus.attached_doc_path) }}" target="_blank" class="hover:underline">
          Sustento de Suspensión (Jefe) - ({{ sus.status }})
        </a>
      </li>
    {% endfor %}
  </ul>
</div>
{% endif %}
</div>
  <div class="bg-white shadow-md rounded-lg p-6">
    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Historial y Observaciones</h3>
    
    {% if user.role in ['admin', 'hr', 'manager'] %}
    <form action="{{ url_for('action_add_comment', vacation_id=vacation.id) }}" method="post" class="mb-6">
      <label for="log_text" class="block text-sm font-medium text-gray-700">Añadir Observación:</label>
      <textarea name="log_text" id="log_text" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
      <button type="submit" class="mt-2 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
        Publicar Observación
      </button>
    </form>
    {% endif %}

    <div class="flow-root">
      <ul role="list" class="-mb-8">
        {% for log in logs %}
        <li>
          <div class="relative pb-8">
            {% if not loop.last %}
            <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
            {% endif %}
            <div class="relative flex space-x-3">
              <div>
                <span class="h-8 w-8 rounded-full bg-gray-400 flex items-center justify-center ring-8 ring-white">
                  <svg class="h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                  </svg>
                </span>
              </div>
              <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                <div>
                  <p class="text-sm text-gray-500">
                    <span class="font-medium text-gray-900">{{ log.user.full_name or log.user.username }}</span> ({{ log.user.role }})
                  </p>
                  <p class="text-sm text-gray-700 mt-1">{{ log.log_text }}</p>
                </div>
                <div class="text-right text-sm whitespace-nowrap text-gray-500">
                  <time datetime="{{ log.created_at.isoformat() }}">{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</time>
                </div>
              </div>
            </div>
          </div>
        </li>
        {% else %}
        <li>
          <p class="text-sm text-gray-500">No hay historial para esta solicitud.</p>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endblock %}