{% extends "base.html" %}

{% block title %}Reportes y Gestión{% endblock %}

{% block content %}
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800">
      Centro de Reportes
    </h1>
    <a href="{{ url_for('admin_dashboard') }}" class="text-blue-600 hover:underline flex items-center">
      &larr; Volver al Panel
    </a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    
    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 hover:shadow-lg transition border-t-4 border-t-green-500">
      <h3 class="text-xl font-bold text-gray-800 mb-2">Planificación por Áreas</h3>
      <p class="text-gray-500 text-sm mb-4">Cronograma de vacaciones futuras.</p>
      <a href="{{ url_for('report_planned') }}" class="btn btn-success w-100 block text-center py-2 bg-green-600 text-white rounded">Descargar Excel</a>
    </div>

    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 hover:shadow-lg transition border-t-4 border-t-blue-500">
      <h3 class="text-xl font-bold text-gray-800 mb-2">Reporte de Saldos</h3>
      <p class="text-gray-500 text-sm mb-4">Balance de días pendientes.</p>
      <a href="{{ url_for('report_balances') }}" class="btn btn-primary w-100 block text-center py-2 bg-blue-600 text-white rounded">Descargar Excel</a>
    </div>

    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 hover:shadow-lg transition border-t-4 border-t-purple-500">
      <h3 class="text-xl font-bold text-gray-800 mb-2">Historial Global</h3>
      <p class="text-gray-500 text-sm mb-4">Registro histórico completo.</p>
      <a href="{{ url_for('report_history') }}" class="btn btn-secondary w-100 block text-center py-2 bg-purple-600 text-white rounded">Descargar Excel</a>
    </div>
  </div>
    
  <div class="row mb-4 mt-5">
      <div class="col-lg-12">
          <div class="card shadow">
              <div class="card-header bg-warning text-white font-weight-bold p-3">
                  <i class="fas fa-exclamation-triangle"></i> Alertas del Sistema ({{ alerts.total_alerts }})
              </div>
              <div class="card-body p-4 bg-white">
                  {% if alerts.total_alerts == 0 %}
                      <p class="mb-0 text-success font-weight-bold"><i class="fas fa-check-circle"></i> Todo está en orden. No hay alertas.</p>
                  {% else %}
                      {% if alerts.missing_schedule %}
                          <h5 class="card-title text-danger font-bold mt-2">Empleados con mucho saldo pendiente (>10 días)</h5>
                          <ul class="list-disc pl-5 mb-4">
                          {% for u in alerts.missing_schedule %}
                              <li>
                                  <b>{{ u.full_name }}</b> ({{ u.email }}) 
                                  - Pendiente: <span class="text-red-600 font-bold">{{ u.balance }} días</span>
                              </li>
                          {% endfor %}
                          </ul>
                      {% endif %}

                      {% if alerts.managers_pending %}
                          <h5 class="card-title mt-4 text-danger font-bold">Jefes con solicitudes en borrador de sus equipos</h5>
                          <ul class="list-disc pl-5">
                          {% for manager in alerts.managers_pending %}
                              <li>{{ manager.full_name }} ({{ manager.email }})</li>
                          {% endfor %}
                          </ul>
                      {% endif %}
                  {% endif %}
              </div>
          </div>
      </div>
  </div>

  <div class="card mb-4 shadow mt-4">
      <div class="card-header bg-gray-100 p-3 font-bold border-b">
          <i class="fas fa-table mr-1"></i>
          Listado de Personal con Derecho a Vacaciones ({{ users | length }})
      </div>
      <div class="card-body p-0">
          <div class="table-responsive">
              <table class="table table-striped mb-0" id="dataTable" width="100%" cellspacing="0">
                  <thead class="bg-gray-200 text-gray-700">
                      <tr>
                          <th class="p-3">Nombre Completo</th>
                          <th class="p-3">Email</th>
                          <th class="p-3">Rol</th>
                          <th class="p-3 text-center">Total Anual</th>
                          <th class="p-3 text-center">Tomados</th>
                          <th class="p-3 text-center">Saldo</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for user in users %}
                      <tr class="border-b hover:bg-gray-50">
                          <td class="p-3"><a href="/gestion/admin/users/{{ user.id }}/edit" class="text-blue-600 hover:underline">{{ user.full_name }}</a></td>
                          <td class="p-3">{{ user.email }}</td>
                          <td class="p-3">
                              {{ user.role }}
                              {% if user.role == 'manager' and user.can_request_own_vacation %} 
                                  <span class="badge badge-info bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs ml-2">Auto-Gestión</span>
                              {% endif %}
                          </td>
                          <td class="p-3 text-center">{{ user.vacation_days_total }}</td>
                          <td class="p-3 text-center">{{ user.vacation_days_taken }}</td>
                          <td class="p-3 text-center font-bold {% if user.balance > 10 %}text-red-600{% else %}text-green-600{% endif %}">
                              {{ user.balance }}
                          </td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
          </div>
      </div>
  </div>
{% endblock %}